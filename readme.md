# Тестовое задание

В рамках тестового задания нужно написать скрипт, который будет анализировать логи веб-сервера по расписанию на наличие 50x ошибок.
Используя SaltStack установить на сервере nginx + php-fpm, подготовленный скрипт, запускающийся по расписанию.


## Как реализовано

Разворачивание тестовой среды происходит на двух vagrant-боксах (bento/ubuntu-16.04).

Salt-мастер: saltmaster.local (192.168.50.10).
Salt-миньон: saltminion.local (192.168.50.11).

Изменение ip-адресов боксов не приводит к краху окружения, для удобства изменения адресов созданы переменные master_ip и minion_ip.

У миньона настроена синхронизированная директория logs (/var/log/analyzer-script-log/) для просмотра логов работы скрипта без доступа к гостевой системе.

С помощью saltstate разворачивается (packages-install.sls) и конфигурируется (services-config.sls) nginx и php-fpm 7.0, а также добавляется cron задание на запуск скрипта (script-add.sls).

Все конфигурационные файлы хранятся на мастере и "пушатся" на миньоны через file.managed.

Скрипт написан на python (saltstack/salt/files/analyzer.py) и выполняется ежеминутно.

Результатом выполнения скрипта является файл с меткой даты в имени файла. Все записи заносятся в один файл в течение дня.

В случае отсутствия ошибок в логах веб-сервера скриптом в журнал записи не заносятся!

## Зависимости

Для корректного взаимодействия между боксами через hostname (с помощью файла hosts) требуется установка плагина Vagrant Host Manager - https://github.com/devopsgroup-io/vagrant-hostmanager

Для этого необходимо выполнить:

```
$ vagrant plugin install vagrant-hostmanager
```

## Запуск и тестирование

Для запуска окружения необходимо клонировать репозиторий себе на машину и в корневой директории выполнить:

```
$ vagrant up
```

### Проверка веб-сервера, php и генерация ошибок

Для доступа к веб-серверу можно использовать http://saltminion.local/ (хост прописывается на гостевой системе с помощью плагина), http://192.168.50.11/ (ip по умолчанию) или http://127.0.0.1:8080/ (выполнен проброс порта).

/ - дефолтная индекс страница nginx.

info.php - проверка функционирования php-fpm.

error.php - страница-генератор ошибки 500 в логи веб-сервера (вызов страницы +1 ошибка в журнале).

### Результат работы скрипта

Скрипт генерирует логи своей работы в папку /var/log/analyzer-script-log/ (logs на хосте, синхронизирована).

### Пример

Папка logs-examples содержит примеры логов скрипта.
